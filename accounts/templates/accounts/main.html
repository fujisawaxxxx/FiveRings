<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>メイン画面0012</title>

    <!-- テーブルのデザイン -->
    <style>
        .copy-options-table {
            width: 50%;
            border-collapse: collapse;
        }
        .copy-options-table th, .copy-options-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        .copy-options-table th {
            background-color: #f2f2f2;
        }
        #estimate-result {
            font-size: 18px; /* 文字サイズを18pxに設定 */
        }
        #estimate-tnk {
            font-size: 10px; /* 文字サイズを10pxに設定 */
        }
    </style>

    <script>
        //商品のプルダウン選択時
        function toggleCopyOptions() {
            var selectedProduct = document.getElementById("document-type").value;
            var copyOptions = document.getElementById("copy-options");

            // 商品選択に応じて複写オプションの表示/非表示を切り替え
            if (selectedProduct === "consent-color" || selectedProduct === "consent-monochrome") {
                copyOptions.style.display = "block";
            } else {
                copyOptions.style.display = "none";
            }

            // 以下の項目をリセット
            document.getElementById("quantity").value = ""; // 数量をクリア
            document.getElementById("content").value = ""; // 本文をクリア
            document.getElementById("total-pages-result").innerText = "総頁数: -"; // 総頁数をクリア
            document.getElementById("estimate-result").innerText = "見積もり金額: - 円"; // 見積もり金額をクリア
            document.getElementById("estimate-tnk").innerText = "単価: - 円"; // 単価をクリア
            document.getElementById("discount-message").innerText = ""; // 割引メッセージをクリア
            document.getElementById("additional-charge-label").innerText = "追加料金: - 円"; // 追加料金をクリア

            // 複写オプションの選択状態をリセット
            document.getElementById("fukusha1").selectedIndex = 0; // 複写1をリセット
            document.getElementById("fukusha2").selectedIndex = 0; // 複写2をリセット
            document.getElementById("fukusha3").selectedIndex = 0; // 複写3をリセット
            document.getElementById("fukusha4").selectedIndex = 0; // 複写なしミシン目をリセット
            document.getElementById("fukusha5").selectedIndex = 0; // 複写オプション追加料金をリセット

            // 複写オプションの表示を初期化
            document.getElementById("fukusha1-label").innerText = "-";
            document.getElementById("fukusha2-label").innerText = "-";
            document.getElementById("fukusha3-label").innerText = "-";
            document.getElementById("fukusha4-label").innerText = "-";
            document.getElementById("atsugami2-label").innerText = "-";
            document.getElementById("atsugami3-label").innerText = "-";
        }

        // ★★★★★　　複写1のプルダウン選択時START　★★★★★
        // 「複写1」オプションのプルダウンメニューが変更されたときの動作を定義した関数
        function toggleCopyOptionsfukusha1() {
            var selectedValue = document.getElementById("fukusha1").value;
            // onchange="toggleCopyOptionsfukusha1()"によって呼び出されて処理を実行しているが、
            // JS側はどこから呼び出されたはわかっていない為、まずid="fukusha1" の <select> 要素から呼び出されたことを教える


            var fukusya_page = document.getElementById("fukusha1-label");
            // HTMLから、id="fukusha1-label" を持つ要素（この場合は <span> タグ）を探して取得。
            // fukusya_page という変数は、<span id="fukusha1-label"> を操作できる
            
            switch (selectedValue) {
                case "fukusha1-0":
                    fukusya_page.innerText = "0";
                    break;
                case "fukusha1-1":
                    fukusya_page.innerText = "-2";
                    break;
                case "fukusha1-2":
                    fukusya_page.innerText = "0";
                    break;
                case "fukusha1-3":
                    fukusya_page.innerText = "2";
                    break;
                case "fukusha1-4":
                    fukusya_page.innerText = "4";
                    break;
                default:
                    fukusya_page.innerText = "0";
            }
            // 選択された値に応じて、ラベル（fukusha1-label）のブラウザ上のテキストを変更

        }
        // ★★★★★　　複写1のプルダウン選択時END 　★★★★★



        // ★★★★★　　複写2のプルダウン選択時START　★★★★★
        function toggleCopyOptionsfukusha2() {
            var selectedValue = document.getElementById("fukusha2").value;
            var fukusya_page = document.getElementById("fukusha2-label");
            var atsugami_page = document.getElementById("atsugami2-label");

            switch (selectedValue) {
                case "fukusha2-0":
                    fukusya_page.innerText = "0";
                    atsugami_page.innerText = "0";
                    break;
                case "fukusha2-1":
                    fukusya_page.innerText = "4";
                    atsugami_page.innerText = "2";
                    break;
                case "fukusha2-2":
                    fukusya_page.innerText = "6";
                    atsugami_page.innerText = "2";
                    break;
                case "fukusha2-3":
                    fukusya_page.innerText = "8";
                    atsugami_page.innerText = "2";
                    break;
                case "fukusha2-4":
                    fukusya_page.innerText = "10";
                    atsugami_page.innerText = "2";
                    break;
                default:
                    fukusya_page.innerText = "0";
                    atsugami_page.innerText = "0";
            }
        }
        // ★★★★★　　複写2のプルダウン選択時END 　★★★★★

        // ★★★★★　　複写3のプルダウン選択時START　★★★★★
        function toggleCopyOptionsfukusha3() {
            var selectedValue = document.getElementById("fukusha3").value;
            var fukusya_page = document.getElementById("fukusha3-label");
            var atsugami_page = document.getElementById("atsugami3-label");

            switch (selectedValue) {
                case "fukusha3-0":
                    fukusya_page.innerText = "0";
                    atsugami_page.innerText = "0";
                    break;
                case "fukusha3-1":
                    fukusya_page.innerText = "4";
                    atsugami_page.innerText = "2";
                    break;
                case "fukusha3-2":
                    fukusya_page.innerText = "6";
                    atsugami_page.innerText = "2";
                    break;
                case "fukusha3-3":
                    fukusya_page.innerText = "8";
                    atsugami_page.innerText = "2";
                    break;
                case "fukusha3-4":
                    fukusya_page.innerText = "10";
                    atsugami_page.innerText = "2";
                    break;
                default:
                    fukusya_page.innerText = "0";
                    atsugami_page.innerText = "0";
            }
        }
        // ★★★★★　　複写3のプルダウン選択時END 　★★★★★

        // ★★★★★　　複写なしミシン目のプルダウン選択時START　★★★★★
        function toggleCopyOptionsfukusha4() {
            var selectedValue = document.getElementById("fukusha4").value;
            var fukusya_page = document.getElementById("fukusha4-label");

            switch (selectedValue) {
                case "fukusha_no-0":
                    fukusya_page.innerText = "0";
                    break;
                case "fukusha_no-1":
                    fukusya_page.innerText = "2";
                    break;
                case "fukusha_no-2":
                    fukusya_page.innerText = "4";
                    break;
                case "fukusha_no-3":
                    fukusya_page.innerText = "6";
                    break;
                default:
                    fukusya_page.innerText = "0";
            }
        }
        // ★★★★★　　複写なしミシン目のプルダウン選択時END 　★★★★★

        // 追加料金を表示
        function displayAdditionalCharge() {
            var copyOptionValue = document.getElementById("fukusha5").value;
            var additionalCharge = 0;

            switch (copyOptionValue) {
                case "fukusha_add_price-1":
                    additionalCharge = 60;
                    break;
                case "fukusha_add_price-2":
                    additionalCharge = 40;
                    break;
                case "fukusha_add_price-3":
                    additionalCharge = 50;
                    break;
                case "fukusha_add_price-4":
                    additionalCharge = 30;
                    break;
                default:
                    additionalCharge = 0;
            }

            document.getElementById("additional-charge-label").innerText = "追加料金: " + additionalCharge + " 円";
        }



        // 見積もり計算ボタンの動作
        function calculateEstimate() {
            var quantity = parseFloat(document.getElementById("quantity").value) || 0;
            var content = parseFloat(document.getElementById("content").value) || 0;
            var selectedProduct = document.getElementById("document-type").value;

            // 数量または本文が0の場合
            if (quantity === 0 || content === 0) {
                document.getElementById("estimate-result").innerText = "数量または本文が未入力です。";
                document.getElementById("estimate-tnk").innerText = ""; // 単価をクリア
                document.getElementById("discount-message").innerText = ""; // 割引メッセージをクリア
                document.getElementById("total-pages-result").innerText = "総頁数: -"; // 総頁数をクリア
                return; // 計算処理を中断
            }

            // 各複写オプションページ数と厚紙オプションページ数を取得
            var fukusha1Page = parseInt(document.getElementById("fukusha1-label").innerText.replace("", "")) || 0;
            var fukusha2Page = parseInt(document.getElementById("fukusha2-label").innerText.replace("", "")) || 0;
            var fukusha3Page = parseInt(document.getElementById("fukusha3-label").innerText.replace("", "")) || 0;
            var fukusha4Page = parseInt(document.getElementById("fukusha4-label").innerText.replace("", "")) || 0;
            var atsugami2Page = parseInt(document.getElementById("atsugami2-label").innerText.replace("", "")) || 0;
            var atsugami3Page = parseInt(document.getElementById("atsugami3-label").innerText.replace("", "")) || 0;

            // 総頁数の計算（本文頁数 + 各複写頁数 + 各厚紙頁数）
            var totalPages = content + fukusha1Page + fukusha2Page + fukusha3Page + fukusha4Page + atsugami2Page + atsugami3Page;
            document.getElementById("total-pages-result").innerText = "総頁数: " + totalPages;

            // 商品別に異なるAPIエンドポイントを設定
            let apiUrl;
            if (selectedProduct === "consent-color") {
                apiUrl = `/items/api/agree-color/?content=${totalPages}`;
            } else if (selectedProduct === "consent-monochrome") {
                apiUrl = `/items/api/agree-monochrome/?content=${totalPages}`;
            } else if (selectedProduct === "case-card") {
                apiUrl = `/items/api/casecard-price/?content=${content}`;
            } else if (selectedProduct === "chiken-plan") {
                apiUrl = `/items/api/chiken-plan-price/?content=${content}`;
            } else if (selectedProduct === "medication-diary") {
                apiUrl = `/items/api/medication-diary-price/?content=${content}`;
            }

            // 追加料金を取得
            var copyOptionValue = document.getElementById("fukusha5").value;
            var additionalCharge = 0;
            switch (copyOptionValue) {
                case "fukusha_add_price-1":
                    additionalCharge = 60;
                    break;
                case "fukusha_add_price-2":
                    additionalCharge = 40;
                    break;
                case "fukusha_add_price-3":
                    additionalCharge = 50;
                    break;
                case "fukusha_add_price-4":
                    additionalCharge = 30;
                    break;
                default:
                    additionalCharge = 0;
            }

            // APIリクエストの実行
            if (apiUrl) {
                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.unit_price) {
                            var unitPrice = parseFloat(data.unit_price);

                            // すべて複写なしのとき50円引き
                            var isNoCopyOption = (
                                document.getElementById("fukusha1").value === "fukusha1-0" &&
                                document.getElementById("fukusha2").value === "fukusha2-0" &&
                                document.getElementById("fukusha3").value === "fukusha3-0"
                            );

                            if (isNoCopyOption) {
                                unitPrice -= 50;
                                document.getElementById("discount-message").innerText = "すべて複写なし：50円引き";
                            } else {
                                document.getElementById("discount-message").innerText = ""; // メッセージをクリア
                            }

                            // 追加料金を単価に加算
                            unitPrice += additionalCharge;

                            // 見積もり金額の計算
                            var totalPrice = quantity * unitPrice;
                            document.getElementById("estimate-result").innerText = "見積もり金額: " + totalPrice + "円";
                            document.getElementById("estimate-tnk").innerText = "単価: " + unitPrice + "円";
                        } else {
                            document.getElementById("estimate-result").innerText = "該当するデータが見つかりません。";
                            document.getElementById("estimate-tnk").innerText = "";
                        }
                    })
                    .catch(error => {
                        console.error("Fetch Error:", error);
                        document.getElementById("estimate-result").innerText = "エラーが発生しました。";
                    });
            }
        }


        function order_create() {
            // 必要なデータを取得
            const productType = document.getElementById("document-type").value;
            const quantity = document.getElementById("quantity").value || "-";
            const content = document.getElementById("content").value || "-";
            const unitPrice = document.getElementById("estimate-tnk").innerText.replace("単価: ", "").replace("円", "") || "-";
            const estimateResult = document.getElementById("estimate-result").innerText.replace("見積もり金額: ", "").replace("円", "") || "-";

            // URLにデータを渡して遷移
            const url = `{% url 'create_order' %}?product_type=${encodeURIComponent(productType)}&quantity=${encodeURIComponent(quantity)}&content=${encodeURIComponent(content)}&unit_price=${encodeURIComponent(unitPrice)}&estimate_result=${encodeURIComponent(estimateResult)}`;
            window.location.href = url;
        }


        window.onload = toggleCopyOptions;
    </script>
</head>
<body>
    <h1>メイン画面</h1>
    <p>ログイン成功！</p>

    <!-- ★★★★★　商品を選択するプルダウンメニュー　START　★★★★★-->
    <label for="document-type">商品を選択してください:</label>
    <select id="document-type" name="document_type" onchange="toggleCopyOptions()">
        <option value="consent-color">同意説明書（カラー）</option>
        <option value="consent-monochrome">同意説明書（モノクロ）</option>
        <option value="case-card">ケースカード（症例報告書）</option>
        <option value="chiken-plan">治験実施計画書</option>
        <option value="medication-diary">服薬日誌</option>
    </select>

    <!-- onchange="toggleCopyOptions()": 商品を選択したときに、JavaScript関数toggleCopyOptionsを実行。 -->
    <!-- ★★★★★　商品を選択するプルダウンメニュー END　　★★★★★-->



    <!-- ★★★★★　数量と本文の入力フィールド　START　★★★★★-->
    <h2>数量と本文</h2>
    <label for="quantity">数量:</label>
    <input type="number" id="quantity" name="quantity" min="1" step="1" required><label>部</label><br><br> 

    <label for="content">本文:</label>
    <input type="number" id="content" name="content" min="2" step="2" required><label>頁</label><br><br><br>

    <!--
    ・type="number": 数値専用の入力欄。
    ・id="quantity"とid="content": JavaScriptでこれらの値を取得するための識別子。
    ・min="1": 数量は1以上で入力する制限。
    ・step="1"：増減±1。
    ・required: 入力必須フィールド。 -->

    <!-- ★★★★★　数量と本文の入力フィールド END　　★★★★★-->

    <!-- ★★★★★　複写オプションの設定（テーブル）　START　★★★★★-->
    <div id="copy-options">
        <h2>複写オプション</h2>
        <table class="copy-options-table">
            <tr>
                <!-- テーブルのヘッダー -->
                <th>複写</th>
                <th>選択</th>
                <th>複写頁数</th>
                <th>厚紙頁数</th>
            </tr>
            <tr>
                <!-- テーブル1行目 -->
                <!-- 1行目1列目 -->
                <td>複写1:</td>

                <!-- 1行目2列目 -->
                <td>
                    <select id="fukusha1" name="fukusha1" onchange="toggleCopyOptionsfukusha1()">
                        <option value="fukusha1-2">3枚6頁（基本）</option>
                        <option value="fukusha1-0">複写なし</option>
                        <option value="fukusha1-1">2枚4頁</option>
                        <option value="fukusha1-3">4枚8頁</option>
                        <option value="fukusha1-4">5枚10頁</option>
                    </select>
                    <!-- デフォルトで最初の選択肢（3枚6頁（基本））が表示されます。
                     この要素は「複写1」に関連し、選択が変更されると onchange 属性で指定された
                     関数 toggleCopyOptionsfukusha1 が呼び出される -->
                </td>

                <!-- 1行目3列目 -->
                <td><span id="fukusha1-label">-</span></td>
                <!-- 初期状態は「-」 -->

                <!-- 1行目4列目 -->
                <td></td>
            </tr>
            <tr>
                <!-- テーブル2行目 -->
                <!-- 2行目1列目 -->
                <td>複写2:</td>

                <!-- 2行目2列目 -->
                <td>
                    <select id="fukusha2" name="fukusha2" onchange="toggleCopyOptionsfukusha2()">
                        <option value="fukusha2-0">複写なし</option>
                        <option value="fukusha2-1">2枚4頁</option>
                        <option value="fukusha2-2">3枚6頁</option>
                        <option value="fukusha2-3">4枚8頁</option>
                        <option value="fukusha2-4">5枚10頁</option>
                    </select>
                </td>

                <!-- 2行目3列目 -->
                <td><span id="fukusha2-label">-</span></td>

                <!-- 2行目4列目 -->
                <td><span id="atsugami2-label">-</span></td>
            </tr>
            <tr>
                <!-- テーブル3行目 -->
                <!-- 3行目1列目 -->
                <td>複写3:</td>
                <!-- 3行目2列目 -->
                <td>
                    <select id="fukusha3" name="fukusha3" onchange="toggleCopyOptionsfukusha3()">
                        <option value="fukusha3-0">複写なし</option>
                        <option value="fukusha3-1">2枚4頁</option>
                        <option value="fukusha3-2">3枚6頁</option>
                        <option value="fukusha3-3">4枚8頁</option>
                        <option value="fukusha3-4">5枚10頁</option>
                    </select>
                </td>
                <!-- 3行目3列目 -->
                <td><span id="fukusha3-label">-</span></td>
                <!-- 3行目4列目 -->
                <td><span id="atsugami3-label">-</span></td>
            </tr>
            <tr>
                <!-- テーブル4行目 -->
                <!-- 4行目1列目 -->
                <td>複写なしミシン目:</td>
                <!-- 4行目2列目 -->
                <td>
                    <select id="fukusha4" name="fukusha4" onchange="toggleCopyOptionsfukusha4()">
                        <option value="fukusha_no-0">なし</option>
                        <option value="fukusha_no-1">1枚2頁</option>
                        <option value="fukusha_no-2">2枚4頁</option>
                        <option value="fukusha_no-3">3枚6頁</option>
                    </select>
                </td>
                <!-- 4行目3列目 -->
                <td><span id="fukusha4-label">-</span></td>
                <!-- 4行目4列目 -->
                <td></td>
            </tr>
        </table>
        <!-- ★★★★★　複写オプションの設定（テーブル）　END 　★★★★★-->

        <br>
        <label for="fukusha5">複写オプション:</label>
        <select id="fukusha5" name="fukusha5" onchange="displayAdditionalCharge()">
            <option value="fukusha_add_price-0">オプションなし</option>
            <option value="fukusha_add_price-1">カラー3枚複写</option>
            <option value="fukusha_add_price-2">カラー2枚複写</option>
            <option value="fukusha_add_price-3">両面3枚複写</option>
            <option value="fukusha_add_price-4">両面2枚複写</option>
        </select>
        <span id="additional-charge-label">追加料金: - 円</span>

        <p id="total-pages-result">総頁数: -</p>
        <p id="discount-message"></p>
    </div>

    <button type="button" onclick="calculateEstimate()">見積もり計算</button><br><br>

    
    <p id="estimate-result">見積もり金額: - 円</p>
    <p id="estimate-tnk">単価: - 円</p>
    <br>
    <button type="button" onclick="order_create()">注文書作成</button>
    <br><br>
</body>
</html>